<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Gateway</title>
    <link rel="icon" type="image/jpeg" href="/static/assets/icon.jpg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="sidebar">
        <div class="logo">
            <span>AI Gateway</span>
            <button class="theme-toggle" onclick="toggleTheme()" title="切换主题">🌙</button>
        </div>
        <ul class="nav-menu">
            <li><a href="#" data-page="dashboard" class="active">📊 仪表盘</a></li>
            <li><a href="#" data-page="channels">📡 渠道</a></li>
            <li><a href="#" data-page="accounts">👤 账号</a></li>
            <li><a href="#" data-page="users">👥 用户</a></li>
            <li><a href="#" data-page="tokens">🔑 令牌</a></li>
            <li><a href="#" data-page="logs">📝 日志</a></li>
            <li><a href="#" data-page="profile">⚙️ 个人中心</a></li>
            <li id="cache-config-menu" style="display:none;"><a href="#" data-page="cache-config">🗄️ 缓存配置</a></li>
            <li id="risk-proxy-menu" style="display:none;"><a href="#" data-page="risk-proxy-pool">🌐 代理池管理</a></li>
            <li id="risk-health-menu" style="display:none;"><a href="#" data-page="risk-health-monitor">💊 账号健康</a></li>
            <li id="risk-rate-menu" style="display:none;"><a href="#" data-page="risk-rate-limit">⏱️ 速率限制</a></li>
            <li id="risk-config-menu" style="display:none;"><a href="#" data-page="risk-config">⚙️ 系统配置</a></li>
        </ul>
        
        <!-- User Info Section -->
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">
                <span id="user-avatar-text">A</span>
            </div>
            <div class="user-details">
                <div class="user-email" id="user-email">加载中...</div>
                <div class="user-role" id="current-user-role"></div>
            </div>
            <button class="btn-logout" onclick="logout()" title="退出登录">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </button>
        </div>
    </nav>
    
    <main class="content">
        <!-- Dashboard -->
        <section id="page-dashboard" class="page active">
            <div class="page-header"><h1>仪表盘</h1></div>
            
            <!-- Risk Control Status (super_admin only) -->
            <div id="risk-control-status" style="display:none; margin-bottom: 24px;">
                <h2>🛡️ 风控系统状态</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>代理池</h3>
                        <p id="dashboard-proxy-status">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>速率限制</h3>
                        <p id="dashboard-rate-status">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>账号健康</h3>
                        <p id="dashboard-health-status">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>指纹伪装</h3>
                        <p id="dashboard-fingerprint-status">-</p>
                    </div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card"><h3>总请求数</h3><p id="stat-requests">-</p></div>
                <div class="stat-card"><h3>总Token数</h3><p id="stat-tokens">-</p></div>
                <div class="stat-card"><h3>缓存命中率</h3><p id="stat-cache-hit">-</p></div>
                <div class="stat-card"><h3>平均耗时</h3><p id="stat-duration">-</p></div>
                <div class="stat-card"><h3>错误率</h3><p id="stat-errors">-</p></div>
                <div class="stat-card"><h3>配额使用</h3><p id="stat-quota">-</p></div>
            </div>
            
            <div id="channel-stats-section">
                <h2>渠道统计</h2>
                <div class="table-container">
                    <table id="channel-stats">
                        <thead><tr><th>渠道</th><th>类型</th><th>账号数</th><th>活跃账号</th><th>Token消耗</th><th>状态</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <h2>请求趋势</h2>
            <div class="chart-container">
                <canvas id="requests-chart"></canvas>
            </div>
            
            <h2>Token趋势</h2>
            <div class="chart-container">
                <canvas id="tokens-chart"></canvas>
            </div>
            
            <h2>模型使用统计</h2>
            <div class="table-container">
                <table id="model-stats">
                    <thead><tr><th>模型</th><th>请求数</th><th>Token数</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div id="top-users-section">
                <h2>Top 用户</h2>
                <div class="table-container">
                    <table id="top-users">
                        <thead><tr><th>用户</th><th>输入Token</th><th>输出Token</th><th>总Token</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Channels -->
        <section id="page-channels" class="page">
            <div class="page-header">
                <h1>Provider 管理</h1>
                <div class="btn-group">
                    <button class="btn" onclick="refreshAllUsage()">刷新用量</button>
                    <p style="color: #6b7280; font-size: 0.875rem; margin: 0;">Provider 自动发现，无需手动添加</p>
                </div>
            </div>
            <div id="channels-grid" class="card-grid"></div>
        </section>
        
        <!-- Accounts (All) -->
        <section id="page-accounts" class="page">
            <div class="page-header">
                <h1>所有账号</h1>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="showAccountModalWithChannel()">+ 添加账号</button>
                    <button class="btn btn-primary" onclick="showImportModalWithChannel()">导入账号</button>
                    <button class="btn" onclick="refreshAllUsage()">刷新用量</button>
                </div>
            </div>
            <div id="accounts-all-grid" class="card-grid"></div>
        </section>

        <!-- Channel Accounts -->
        <section id="page-channel-accounts" class="page">
            <div class="page-header">
                <h1>账号管理 - <span id="accounts-channel-name"></span></h1>
                <div class="btn-group">
                    <button class="btn" onclick="showChannelsPage()">返回</button>
                    <button class="btn" onclick="refreshCurrentChannelUsage()" id="btn-refresh-channel">刷新用量</button>
                    <button class="btn btn-primary" onclick="showAccountModal()">+ 添加</button>
                    <button class="btn btn-primary" onclick="showImportModal()">导入</button>
                    <button class="btn btn-danger" onclick="clearAllAccounts()">清空全部</button>
                </div>
            </div>
            <div id="accounts-grid" class="card-grid"></div>
        </section>
        
        <!-- Users -->
        <section id="page-users" class="page">
            <div class="page-header">
                <h1>用户管理</h1>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="showUserModal()">+ 添加用户</button>
                </div>
            </div>
            <div id="users-grid" class="card-grid"></div>
        </section>
        
        <!-- Tokens -->
        <section id="page-tokens" class="page">
            <div class="page-header">
                <h1>令牌管理</h1>
                <div class="btn-group" id="token-actions">
                    <button class="btn btn-primary" onclick="showTokenModal()">+ 添加令牌</button>
                </div>
            </div>
            <div id="tokens-grid" class="card-grid"></div>
        </section>
        
        <!-- Logs -->
        <section id="page-logs" class="page">
            <div class="page-header"><h1>请求日志</h1></div>
            <div class="table-container">
                <table id="logs-table">
                    <thead>
                        <tr><th>时间</th><th>用户</th><th>Provider</th><th>模型</th><th>输入Token</th><th>输出Token</th><th>缓存读取</th><th>缓存创建</th><th>压缩</th><th>耗时</th><th>状态</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="margin-top: 16px;"><button class="btn" onclick="loadMoreLogs()">加载更多</button></div>
        </section>
        
        <!-- Profile Page -->
        <section id="page-profile" class="page">
            <div class="page-header"><h1>个人中心</h1></div>
            
            <!-- Basic Info -->
            <div class="card" style="margin-bottom: 24px;">
                <h2>基本信息</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <label>邮箱</label>
                        <span id="profile-email">-</span>
                    </div>
                    <div class="info-item">
                        <label>用户名</label>
                        <span id="profile-name">-</span>
                    </div>
                    <div class="info-item">
                        <label>角色</label>
                        <span id="profile-role-badge">-</span>
                    </div>
                    <div class="info-item">
                        <label>最后登录</label>
                        <span id="profile-last-login">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Usage Stats -->
            <div class="card" style="margin-bottom: 24px;">
                <h2>使用统计</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>总Token数</h3>
                        <p id="profile-total-tokens">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>输入Token</h3>
                        <p id="profile-input-tokens">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>输出Token</h3>
                        <p id="profile-output-tokens">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>配额使用</h3>
                        <p id="profile-quota">-</p>
                    </div>
                </div>
            </div>
            
            <!-- Change Password -->
            <div class="card" style="margin-bottom: 24px;">
                <h2>修改密码</h2>
                <form id="change-password-form" onsubmit="event.preventDefault(); changePassword();" style="max-width: 500px;">
                    <div class="form-group">
                        <label>旧密码</label>
                        <input type="password" id="old-password" required>
                    </div>
                    <div class="form-group">
                        <label>新密码</label>
                        <input type="password" id="new-password" required minlength="6">
                        <small class="help-text">密码长度至少为6位</small>
                    </div>
                    <div class="form-group">
                        <label>确认新密码</label>
                        <input type="password" id="confirm-password" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary">修改密码</button>
                </form>
            </div>
        </section>
        
        <!-- Channel Edit Page -->
        <section id="page-channel-edit" class="page">
            <div class="page-header">
                <h1 id="channel-edit-title">编辑渠道</h1>
                <div class="btn-group">
                    <button class="btn" onclick="showChannelsPage()">返回</button>
                    <button class="btn btn-primary" onclick="saveChannelEdit()">保存</button>
                </div>
            </div>
            <div class="form-container">
                <form id="channel-edit-form" onsubmit="event.preventDefault(); saveChannelEdit();">
                    <input type="hidden" id="edit-channel-id">
                    <div class="form-group">
                        <label>名称</label>
                        <input type="text" id="edit-channel-name" required>
                    </div>
                    <div class="form-group">
                        <label>类型</label>
                        <select id="edit-channel-type" required disabled>
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="google">Google (Gemini)</option>
                            <option value="kiro">Kiro</option>
                        </select>
                        <small class="help-text">类型创建后不可修改</small>
                    </div>
                    <div class="form-group">
                        <label>启用的模型</label>
                        <div id="edit-channel-models-container" class="models-checkbox-container">
                            <small class="help-text">加载中...</small>
                        </div>
                        <small class="help-text">勾选要启用的模型，不勾选则禁用该模型</small>
                    </div>
                    <div class="form-group">
                        <label>优先级</label>
                        <input type="number" id="edit-channel-priority" value="0">
                    </div>
                    <div class="form-group">
                        <label>权重</label>
                        <input type="number" id="edit-channel-weight" value="1" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="edit-channel-enabled">
                            <span>启用渠道</span>
                        </label>
                    </div>
                </form>
            </div>
        </section>
        
        <!-- Account Edit Page -->
        <section id="page-account-edit" class="page">
            <div class="page-header">
                <h1 id="account-edit-title">编辑账号</h1>
                <div class="btn-group">
                    <button class="btn" onclick="backToAccountsList()">返回</button>
                    <button class="btn btn-primary" onclick="saveAccountEdit()">保存</button>
                </div>
            </div>
            <div class="form-container">
                <form id="account-edit-form" onsubmit="event.preventDefault(); saveAccountEdit();">
                    <input type="hidden" id="edit-account-id">
                    <input type="hidden" id="edit-account-channel-id">
                    <div class="form-group">
                        <label>名称（可选）</label>
                        <input type="text" id="edit-account-name">
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <textarea id="edit-account-api-key" rows="5" required></textarea>
                        <small class="help-text">Kiro类型请输入JSON格式的凭证</small>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="edit-account-enabled">
                            <span>启用账号</span>
                        </label>
                    </div>
                </form>
            </div>
        </section>
        
        <!-- Cache Config -->
        <section id="page-cache-config" class="page">
            <div class="page-header">
                <h1>🗄️ 缓存配置</h1>
                <button class="btn btn-primary" onclick="saveCacheConfig()">保存配置</button>
            </div>
            <div class="form-container">
                <form id="cache-config-form" onsubmit="event.preventDefault(); saveCacheConfig();">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="cache-prompt-enabled">
                            <span>启用 Prompt Cache（提示词缓存）</span>
                        </label>
                        <small class="help-text">自动识别和利用 AI 提供商的缓存机制，降低重复提示词的成本（缓存读取价格为正常价格的 10-50%）</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="cache-compression-enabled">
                            <span>启用 Context Compression（上下文压缩）</span>
                        </label>
                        <small class="help-text">自动压缩过长的对话历史，减少 token 使用</small>
                    </div>
                    
                    <div class="form-group">
                        <label>压缩触发阈值（Token 数）</label>
                        <input type="number" id="cache-compression-threshold" min="1000" max="100000" step="1000">
                        <small class="help-text">当对话历史超过此 token 数时触发压缩</small>
                    </div>
                    
                    <div class="form-group">
                        <label>压缩目标长度（Token 数）</label>
                        <input type="number" id="cache-compression-target" min="500" max="50000" step="500">
                        <small class="help-text">压缩后的目标 token 数</small>
                    </div>
                    
                    <div class="form-group">
                        <label>压缩策略</label>
                        <select id="cache-compression-strategy">
                            <option value="sliding_window">滑动窗口（保留最近消息）</option>
                            <option value="summary">摘要压缩（使用 AI 总结）</option>
                            <option value="hybrid">混合策略（总结旧消息+保留最近消息）</option>
                        </select>
                        <small class="help-text">选择上下文压缩的策略</small>
                    </div>
                </form>
            </div>
        </section>
        
        <!-- Risk Control: System Overview -->
        
        <!-- Risk Control: Proxy Pool -->
        <section id="page-risk-proxy-pool" class="page">
            <div class="page-header">
                <h1>🌐 代理池管理</h1>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="showAddProxyModal()">添加代理</button>
                    <button class="btn btn-secondary" onclick="healthCheckProxies()">健康检查</button>
                    <button class="btn btn-secondary" onclick="refreshProxyPool()">刷新</button>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>总代理数</h3>
                    <p id="proxy-total">0</p>
                </div>
                <div class="stat-card">
                    <h3>存活代理</h3>
                    <p id="proxy-alive">0</p>
                </div>
                <div class="stat-card">
                    <h3>失效代理</h3>
                    <p id="proxy-dead">0</p>
                </div>
                <div class="stat-card">
                    <h3>绑定策略</h3>
                    <p id="proxy-strategy">-</p>
                </div>
            </div>
            <div class="card">
                <h2>代理列表</h2>
                <div class="table-container">
                    <table id="proxy-list-table">
                        <thead>
                            <tr>
                                <th>代理地址</th>
                                <th>协议</th>
                                <th>状态</th>
                                <th>总请求</th>
                                <th>成功率</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Risk Control: Health Monitor -->
        <section id="page-risk-health-monitor" class="page">
            <div class="page-header">
                <h1>💊 账号健康监控</h1>
                <button class="btn btn-secondary" onclick="refreshHealthMonitor()">刷新</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>总账号数</h3>
                    <p id="health-total">0</p>
                </div>
                <div class="stat-card">
                    <h3>健康账号</h3>
                    <p id="health-healthy">0</p>
                </div>
                <div class="stat-card">
                    <h3>降级账号</h3>
                    <p id="health-degraded">0</p>
                </div>
                <div class="stat-card">
                    <h3>封禁账号</h3>
                    <p id="health-banned">0</p>
                </div>
            </div>
            <div class="card">
                <h2>账号健康详情</h2>
                <div class="table-container">
                    <table id="health-list-table">
                        <thead>
                            <tr>
                                <th>账号ID</th>
                                <th>状态</th>
                                <th>成功率</th>
                                <th>总请求</th>
                                <th>失败请求</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Risk Control: Rate Limit -->
        <section id="page-risk-rate-limit" class="page">
            <div class="page-header">
                <h1>⏱️ 速率限制统计</h1>
                <button class="btn btn-secondary" onclick="refreshRateLimit()">刷新</button>
            </div>
            <div class="card">
                <h2>全局速率限制</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>最近1分钟请求数</h3>
                        <p id="global-requests">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>最近1分钟Token数</h3>
                        <p id="global-tokens">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>RPM限制</h3>
                        <p id="global-rpm-limit">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>TPM限制</h3>
                        <p id="global-tpm-limit">-</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Risk Control: Config -->
        <section id="page-risk-config" class="page">
            <div class="page-header">
                <h1>⚙️ 系统配置</h1>
                <button class="btn btn-primary" onclick="saveRiskConfig()">保存配置</button>
            </div>
            <div class="card">
                <h2>代理池配置</h2>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="config-proxy-enabled">
                        <span>启用代理池</span>
                    </label>
                </div>
                <div class="form-group">
                    <label>绑定策略</label>
                    <select id="config-proxy-strategy">
                        <option value="sticky">STICKY - 账号绑定固定代理</option>
                        <option value="random">RANDOM - 随机选择</option>
                        <option value="round_robin">ROUND_ROBIN - 轮询</option>
                    </select>
                </div>
            </div>
            <div class="card">
                <h2>速率限制配置</h2>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="config-rate-enabled">
                        <span>启用速率限制</span>
                    </label>
                </div>
                <div class="form-group">
                    <label>RPM（每分钟请求数）</label>
                    <input type="number" id="config-global-rpm" value="1000" min="1">
                </div>
                <div class="form-group">
                    <label>TPM（每分钟Token数）</label>
                    <input type="number" id="config-global-tpm" value="1000000" min="1">
                </div>
            </div>
            <div class="card">
                <h2>健康监控配置</h2>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="config-health-enabled">
                        <span>启用健康监控</span>
                    </label>
                </div>
                <div class="form-group">
                    <label>检查间隔（秒）</label>
                    <input type="number" id="config-health-interval" value="60" min="10">
                </div>
            </div>
        </section>
    </main>
    
    <!-- Channel Modal -->
    <div id="channel-modal" class="modal">
        <div class="modal-content">
            <h2 id="channel-modal-title">添加渠道</h2>
            <form id="channel-form">
                <input type="hidden" id="channel-id">
                <div class="form-group">
                    <label>名称</label>
                    <input type="text" id="channel-name" required placeholder="我的渠道">
                </div>
                <div class="form-group">
                    <label>类型</label>
                    <select id="channel-type" required>
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic (Claude)</option>
                        <option value="google">Google (Gemini)</option>
                        <option value="kiro">Kiro</option>
                    </select>
                    <small class="help-text">支持的模型由Provider自动管理</small>
                </div>
                <div class="form-group">
                    <label>优先级（数值越大优先级越高）</label>
                    <input type="number" id="channel-priority" value="0">
                    <small class="help-text">优先级高的渠道会被优先选择</small>
                </div>
                <div class="form-group">
                    <label>权重（1-100）</label>
                    <input type="number" id="channel-weight" value="1" min="1" max="100">
                    <small class="help-text">权重越高，被选中的概率越大</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('channel-modal')">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Account Modal -->
    <div id="account-modal" class="modal">
        <div class="modal-content">
            <h2>添加账号</h2>
            <form id="account-form">
                <div class="form-group" id="account-channel-group" style="display:none;">
                    <label>选择渠道</label>
                    <select id="account-channel-select" required>
                        <option value="">请选择渠道</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>名称（可选）</label>
                    <input type="text" id="account-name" placeholder="账号名称">
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="text" id="account-api-key" required placeholder="sk-...">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('account-modal')">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <h2>导入账号</h2>
            <form id="import-form">
                <div class="form-group" id="import-channel-group" style="display:none;">
                    <label>选择渠道</label>
                    <select id="import-channel-select" required>
                    </select>
                </div>
                <div id="import-standard" class="import-section">
                    <div class="form-group">
                        <label>API Keys（每行一个）</label>
                        <textarea id="import-keys" rows="6" placeholder="sk-xxx&#10;sk-yyy"></textarea>
                    </div>
                </div>
                <div id="import-kiro" class="import-section" style="display:none;">
                    <div class="import-tabs">
                        <button type="button" class="tab-btn active" onclick="switchImportTab('file')">文件</button>
                        <button type="button" class="tab-btn" onclick="switchImportTab('json')">JSON</button>
                        <button type="button" class="tab-btn" onclick="switchImportTab('login')">登录</button>
                    </div>
                    <div id="import-tab-file" class="import-tab-content">
                        <div class="form-group">
                            <label>上传 Kiro 配置文件</label>
                            <input type="file" id="import-file" accept=".json">
                        </div>
                    </div>
                    <div id="import-tab-json" class="import-tab-content" style="display:none;">
                        <div class="form-group">
                            <label>粘贴 JSON</label>
                            <textarea id="import-kiro-json" rows="8" placeholder='[{"refreshToken":"..."}]'></textarea>
                        </div>
                    </div>
                    <div id="import-tab-login" class="import-tab-content" style="display:none;">
                        <p class="help-text">使用 AWS Builder ID 登录</p>
                        <button type="button" class="btn btn-primary" onclick="startKiroLogin()">登录</button>
                        <div id="kiro-login-status" style="display:none; margin-top: 12px;">
                            <p>验证码：<strong id="kiro-login-code"></strong></p>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('import-modal')">取消</button>
                    <button type="submit" class="btn btn-primary">导入</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- User Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <h2 id="user-modal-title">添加用户</h2>
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="form-group">
                    <label>名称</label>
                    <input type="text" id="user-name" placeholder="用户名称" required>
                </div>
                <div class="form-group">
                    <label>角色</label>
                    <select id="user-role" required>
                        <option value="user">普通用户</option>
                        <option value="admin">管理员</option>
                        <option value="super_admin">超级管理员</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>配额（-1 = 无限制）</label>
                    <input type="number" id="user-quota" value="-1">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('user-modal')">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Token Modal -->
    <div id="token-modal" class="modal">
        <div class="modal-content">
            <h2 id="token-modal-title">添加令牌</h2>
            <form id="token-form">
                <input type="hidden" id="token-id">
                <input type="hidden" id="token-user-id">
                <div class="form-group">
                    <label>名称</label>
                    <input type="text" id="token-name" placeholder="令牌名称" required>
                </div>
                <div class="form-group">
                    <label>过期时间（留空 = 永不过期）</label>
                    <input type="datetime-local" id="token-expired-time">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="token-model-limits-enabled">
                        <span>启用模型限制</span>
                    </label>
                </div>
                <div class="form-group" id="token-model-limits-group" style="display:none;">
                    <label>允许的模型（逗号分隔）</label>
                    <input type="text" id="token-model-limits" placeholder="gpt-4,claude-3-opus,gemini-pro">
                    <small class="help-text">例如：gpt-4,gpt-4-turbo,claude-3-opus</small>
                </div>
                <div class="form-group">
                    <label>IP白名单（每行一个，留空 = 允许所有）</label>
                    <textarea id="token-ip-whitelist" rows="3" placeholder="192.168.1.1&#10;10.0.0.0/24"></textarea>
                </div>
                <div class="form-group">
                    <label>分组</label>
                    <input type="text" id="token-group" value="default" placeholder="default">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="token-cross-group-retry">
                        <span>启用跨分组重试</span>
                    </label>
                </div>
                <div class="form-group">
                    <label>速率限制 - RPM（每分钟请求数，0 = 无限制）</label>
                    <input type="number" id="token-rpm-limit" value="0" min="0" placeholder="例如：60">
                    <small class="help-text">限制每分钟最多请求次数</small>
                </div>
                <div class="form-group">
                    <label>速率限制 - TPM（每分钟Token数，0 = 无限制）</label>
                    <input type="number" id="token-tpm-limit" value="0" min="0" placeholder="例如：100000">
                    <small class="help-text">限制每分钟最多Token消耗</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('token-modal')">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="/static/js/chart.min.js"></script>
    <script src="/static/js/app.js?v=3.0"></script>
</body>
</html>
